<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="author" content="Richard Walker">
<title>Pragmatic OpenShift</title>
<style>
/* Custom AsciiDoc stylesheet based on Fedora and Red Hat text font with side TOC */

/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* @import url(https://fonts.googleapis.com/css2?family=Red+Hat+Text); */

@font-face {
    font-family: 'Red Hat Text';
    font-style: normal;
    font-weight: 400;
    src: local('Red Hat Text'), local('RedHatText-Regular'), url(fonts/RedHatText-Regular.woff2) format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Red Hat Text",sans-serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Red Hat Text",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Red Hat Text",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Red Hat Text",sans-serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Red Hat Text",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#ddd}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Red Hat Text",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code{color:rgba(0,0,0,.8)}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Red Hat Text",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */
:root{
    --maincolor:#FFFFFF;
    --primarycolor:#294172; /* Fedora Dark Blue */
    --secondarycolor:#3c6eb4; /* Fedora Blue */
    --tertiarycolor:#CCCCCC;
    --sidebarbackground:#CACACA;
    --linkcolor:#0D47A1;
    --linkcoloralternate:#294172; /* Friends Magneta */
    --white:#FFFFFF; 
    --black:#000000;
    }
    
    /* Text styles */
    
    body{font-family: 'Red Hat Text', sans-serif;background-color: var(--maincolor);color:var(--black);}
    
    h1{color:var(--primarycolor) !important;font-family:"Red Hat Text",sans-serif;}
    h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;font-family:"Red Hat Text",sans-serif;}
    .title{color:var(--black) !important;font-family:"Red Hat Text",sans-serif;font-style: normal; font-weight: normal;}
    a{text-decoration: none;}
    p{font-family: "Red Hat Text",sans-serif ! important}
    #toc.toc2 a:link{color:var(--linkcolor);}
    blockquote{color:var(--linkcoloralternate) !important}
    .quoteblock blockquote:before{color:var(--linkcoloralternate)}
    code{color:var(--black);background-color: var(--highlightcolor) !important}
    mark{background-color: var(--highlightcolor)} /* Text highlighting color */
    
    /* Table styles */
    th{background-color: var(--maincolor);color:var(--black) !important;}
    td{background-color: var(--maincolor);color: var(--black) !important}
    
    
    #toc.toc2{background-color:var(--sidebarbackground);}
    #toctitle{color:var(--white);}
    
    /* Responsiveness fixes */
    video {
      max-width: 100%;
    }
    
    @media all and (max-width: 600px) {
    table {
      width: 55vw!important;
      font-size: 3vw;
    }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Pragmatic OpenShift</h1>
<div class="details">
<span id="author" class="author">Richard Walker</span><br>
<span id="email" class="email"><a href="mailto:me@richardwalker.dev">me@richardwalker.dev</a></span><br>
<span id="revnumber">version 1.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_openshift_4_6">OpenShift 4.6</a>
<ul class="sectlevel2">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_infrastructure">INFRASTRUCTURE</a>
<ul class="sectlevel3">
<li><a href="#_architecture_overview">Architecture overview</a></li>
</ul>
</li>
<li><a href="#_prerequisites">PREREQUISITES</a>
<ul class="sectlevel3">
<li><a href="#_raspberry_pi">Raspberry Pi</a></li>
<li><a href="#_dns">DNS</a></li>
<li><a href="#_haproxy">HAProxy</a></li>
<li><a href="#_apache_web_server">Apache web server</a></li>
</ul>
</li>
<li><a href="#_installation">INSTALLATION</a>
<ul class="sectlevel3">
<li><a href="#_client_tools">Client tools</a></li>
<li><a href="#_install_preparation">Install preparation</a></li>
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_bootstrap_node">Bootstrap node</a></li>
<li><a href="#_master_nodes">Master nodes</a>
<ul class="sectlevel4">
<li><a href="#_master1_cluster_lab_com">master1.cluster.lab.com</a></li>
<li><a href="#_master2_cluster_lab_com">master2.cluster.lab.com</a></li>
<li><a href="#_master3_cluster_lab_com">master3.cluster.lab.com</a></li>
</ul>
</li>
<li><a href="#_completion">Completion</a></li>
<li><a href="#_login">Login</a></li>
<li><a href="#_troubleshooting">Troubleshooting</a>
<ul class="sectlevel4">
<li><a href="#_single_master">Single master</a></li>
<li><a href="#_unknown_authority">Unknown authority</a></li>
<li><a href="#_missing_console">Missing Console</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_nodes">NODES</a>
<ul class="sectlevel3">
<li><a href="#_infra_nodes">Infra nodes</a>
<ul class="sectlevel4">
<li><a href="#_label_infra_nodes">Label infra nodes</a></li>
</ul>
</li>
<li><a href="#_worker_nodes">Worker nodes</a></li>
<li><a href="#_move_ingress_router">Move ingress router</a></li>
<li><a href="#_disable_master_scheduler">Disable master scheduler</a></li>
<li><a href="#_delete_nodes">Delete nodes</a></li>
</ul>
</li>
<li><a href="#_ntpchrony">NTP/CHRONY</a></li>
<li><a href="#_image_registry">IMAGE REGISTRY</a>
<ul class="sectlevel3">
<li><a href="#_nfs_server">NFS server</a></li>
<li><a href="#_nfs_storage_class">NFS storage class</a></li>
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_expose_registry">Expose registry</a></li>
<li><a href="#_migrate_registry">Migrate registry</a></li>
<li><a href="#_troubleshooting_2">Troubleshooting</a>
<ul class="sectlevel4">
<li><a href="#_no_route_to_host">No route to host</a></li>
<li><a href="#_unexpected_status">Unexpected status</a></li>
<li><a href="#_undo_storage_config">Undo storage config</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_local_storage">LOCAL STORAGE</a>
<ul class="sectlevel3">
<li><a href="#_local_storage_class">Local storage class</a></li>
<li><a href="#_adding_block_storage">Adding block storage</a></li>
</ul>
</li>
<li><a href="#_cluster_logging">CLUSTER LOGGING</a>
<ul class="sectlevel3">
<li><a href="#_ephemeral_logging">Ephemeral logging</a></li>
<li><a href="#_local_storage_logging">Local storage logging</a></li>
<li><a href="#_troubleshooting_3">Troubleshooting</a>
<ul class="sectlevel4">
<li><a href="#_insufficient_memory">Insufficient memory</a></li>
<li><a href="#_delete_cluster_logging">Delete cluster logging</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_certificates">CERTIFICATES</a>
<ul class="sectlevel3">
<li><a href="#_local_ca">Local CA</a></li>
<li><a href="#_install_root_certificate">Install root certificate</a></li>
<li><a href="#_signed_certificate">Signed certificate</a></li>
<li><a href="#_ingress_certificate">Ingress certificate</a></li>
<li><a href="#_api_certificate">API certificate</a></li>
<li><a href="#_replace_certificates">Replace certificates</a></li>
<li><a href="#_add_ca_bundle">Add CA Bundle</a></li>
</ul>
</li>
<li><a href="#_identity_providers">IDENTITY PROVIDERS</a>
<ul class="sectlevel3">
<li><a href="#_htpasswd">HTPasswd</a></li>
<li><a href="#_cluster_admin">Cluster admin</a></li>
<li><a href="#_remove_kubeadmin">Remove kubeadmin</a></li>
<li><a href="#_ldap">LDAP</a>
<ul class="sectlevel4">
<li><a href="#_deploy_ldap">Deploy LDAP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_summary">SUMMARY</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Preface</p>
</div>
<div class="paragraph">
<p>OpenShift was first launched in 2011 and relied on Linux containers to deploy and run user applications. In 2014, Kubernetes was open-sourced by Google, pitched as"
a system for automating deployment, scaling, and operations of application containers."</p>
</div>
<div class="paragraph">
<p>The release of OpenShift V3 was quite substantial. OpenShift began using containers and images, and to orchestrate those images, V3 introduced using Kubernetes.</p>
</div>
<div class="paragraph">
<p>Red Hat proved to be at the forefront of container technology, second only to Google in contributions to Cloud Native Computing Foundation (CNCF) projects. Moreover, the acquisition of CoreOS in January 2018. The CoreOS flagship product was a lightweight Linux operating system designed to run containerized applications, and Red Hat made available in OpenShift V4 as "Red Hat Enterprise Linux CoreOS".</p>
</div>
<div class="paragraph">
<p>Red Hat OpenShift is one of those technologies causing a lot of noise and demand for skills in the Information Technology industry. Still relatively young, it is under massive development and evolving faster than professionals can keep up.</p>
</div>
<div class="paragraph">
<p>The pragmatic OpenShift guide aims to provide a hands-on approach to deploying and configuring OpenShift 4.6.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openshift_4_6">OpenShift 4.6</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph">
<p>This document aims to remove the ambiguity sometimes found in the official documentation and using clear examples, demonstrate how to deploy an OpenShift cluster and complete the most common post-installation, configuration tasks.</p>
</div>
<div class="paragraph">
<p>The primary purpose of the information detailed is for learning and building a personal lab environment. Therefore the scenarios are not intended for production use. However, it is the know-how what counts.</p>
</div>
<div class="paragraph">
<p>OpenShift is a rapidly moving target, with minor releases often incrementing weekly, this document is focused on OpenShift 4.6.</p>
</div>
<div class="paragraph">
<p>A challenge for a would-be OpenShift administrator is the accessibility to technology. Minimum requirements are enormous, and let us remember OpenShift (based on Kubernetes) is a cloud-native platform first. Evident from when OpenShift 4.1 was first released. Initially, it only supported Amazon Web Services (AWS) using the Installer Provisioned Infrastructure (IPI).</p>
</div>
<div class="paragraph">
<p>Today, OpenShift now supports AWS, Azure, GCP, IBM, OpenStack, RHV, vSphere and bare metal. All of these have their nuances, and for a home lab, most are too costly for learning and experimenting.</p>
</div>
<div class="paragraph">
<p>Bare metal allows us to provision infrastructure, and the User Provisioned Infrastructure (UPI) installation enables customisations. The process of doing a UPI bare-metal installation is far more involved than say an AWS IPI. However, the knowledge gained is invaluable, and the result is a local cluster, albeit a minimal three-node cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="_infrastructure">INFRASTRUCTURE</h3>
<div class="paragraph">
<p>Infrastructure is the compute resources that software platforms get deployed on to. Traditionally and as demonstrated in this documentation that can be physical hardware. It might mean virtualisation using hypervisors such as VMware, Red Hat Virtualisation or  Hyper-V for example. Most commonly, it will likely mean cloud infrastructure. Cloud infrastructure builds on virtualisation providing on-demand abstracted resources such as hardware,  storage, and network resources.</p>
</div>
<div class="paragraph">
<p>In reality, cloud infrastructure resources are costly and move capital expenditure (CapEx) to operation expenditure (OpEx).  For a lab environment, a monthly bill using cloud resources would equate to the outright purchase of sufficient hardware to keep forever. For production enterprise environments, resilience, scalability and flexibility of OpEx infrastructure are highly appealing and make sense.  However, for learning, experimentation, and keeping costs down with the purchase of hardware for the long term is appealing.</p>
</div>
<div class="paragraph">
<p>This guide demonstrates using  Intel® NUC&#8217;s for master nodes, which are affordable, compact with low power consumption.  Furthermore, a Raspberry Pi used for the core utility services including DNS, Load Balancer and Apache webserver.</p>
</div>
<div class="sect3">
<h4 id="_architecture_overview">Architecture overview</h4>
<div class="paragraph">
<p>The following diagram is a high-level overview of the lab environment deployed in this document. It depicts both the physical hosts and virtual hosts that make up a hybrid cluster.  The virtual hosts include the temporary bootstrap host, only needed during the initial deployment of the three master nodes.</p>
</div>
<div class="paragraph">
<p>Three master nodes make up a minimal cluster. The nodes will play the role of "master", "worker" and "infra" nodes.</p>
</div>
<div class="paragraph">
<p>Further scaling of the cluster is optional and done using virtual machines (VM) with network bridging. Using VMs provides flexibility where resources are limited. Temporarily adding and removing worker and infrastructure nodes is excellent for trying various activities while keeping the three core physical master nodes permanently.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/overview-arch.png" alt="Architecture Overview">
</div>
</div>
<div class="paragraph">
<p>The following table includes the details of the environment used throughout this document:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Host Details</caption>
<colgroup>
<col style="width: 22.2222%;">
<col style="width: 22.2222%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>DNS Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>IP Address</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>client.local</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.35</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>RHEL8/Fedora32 client laptop</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>utilities.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.101</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Raspberry Pi 3 Model B, 4 core 1GB RAM, 8GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>bootstrap.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.102</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>master1.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.111</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Intel NUC i5, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>master2.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.112</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Intel NUC i5, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>master3.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.113</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Intel NUC i5, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Worker and Infra node examples</caption>
<colgroup>
<col style="width: 22.2222%;">
<col style="width: 22.2222%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>DNS Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>IP Address</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>worker1.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.121</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>worker2.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.122</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>worker3.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.123</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>infra1.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.131</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>infra2.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.132</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><strong>infra3.cluster.lab.com</strong></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.0.133</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KVM VM, 4 core, 16GB RAM, 120GB storage</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites">PREREQUISITES</h3>
<div class="paragraph">
<p>Getting the prerequisites right is the essential part of deploying OpenShift. Mistakes with DNS, load balancing or networking in general, will only lead problems with the deployment of the cluster. Troubleshooting OpenShift deployments is notoriously challenging and often misleading towards the real root cause of issues.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
With OpenShift 4, begin with a minimal working deployment, adding subsequent nodes and performing any cluster configuration post-deployment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once bootstrapping is completed, the minimal cluster will look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/overview-min.png" alt="Minimal Target Architecture Overview">
</div>
</div>
<div class="paragraph">
<p>In this guide, a Raspberry Pi is used, but it does not need to be, any host either physical or virtual (providing it is either on the same subnet or sufficient routing configured) with CentOS 7 or 8 install will do.</p>
</div>
<div class="paragraph">
<p>Regardless of the device, Domain Name System (DNS) needs to be in place and the provisioning of two load balancers (LB). One LB for the Application Programming Interface (API) and another LB for ingress application traffic flowing in from outside the cluster. A web server is also needed to serve files and images used for provisioning hosts.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All steps documented assume a Linux client computer either Fedora, CentOS or Red Hat Enterprise Linux.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_raspberry_pi">Raspberry Pi</h4>
<div class="paragraph">
<p>Refer to the following for information regarding CentOS for Raspberry Pi: <a href="https://wiki.centos.org/SpecialInterestGroup/AltArch/Arm32/RaspberryPi3">wiki.centos.org</a></p>
</div>
<div class="paragraph">
<p>In this document <code>CentOS-Userland-7-armv7hl-RaspberryPI-Minimal-2009-sda.raw.xz</code> was used.</p>
</div>
<div class="paragraph">
<p><code>xz</code> is a lossless compression program, if not already installed, install it on your client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dnf install xz -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decompress the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>unxz CentOS-Userland-7-armv7hl-RaspberryPI-Minimal-2009-sda.raw.xz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>fdisk</code> to identify existing storage devices on your system, then insert the MicroSD card, using <code>fdisk</code> again to identify the card:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fdisk -l</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">[ ... output omitted ... ]
Disk /dev/sda: 14.9 GiB, 15931539456 bytes, 31116288 sectors
[ ... output omitted ... ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>dd</code> write the image to the SD card:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">sudo dd if=CentOS-Userland-7-armv7hl-RaspberryPI-Minimal-2009-sda.raw of=/dev/sda bs=8192 status=progress; sync</code></pre>
</div>
</div>
<div class="paragraph">
<p>Insert the SD card and power on the Raspberry Pi, logging in as <code>root</code> with the default password of <code>centos</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Username: root
Password: centos</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expand the filesystem with <code>/usr/bin/rootfs-expand</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/usr/bin/rootfs-expand</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the hostname:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>hostnamectl set-hostname utilities.cluster.lab.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove NetworkManger:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum remove NetworkManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> and configure it as a static IP, I&#8217;m setting it to <code>192.168.0.101</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.0.101
PREFIX=24
GATEWAY=192.168.0.1
DNS1=192.168.0.1</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
As a rule of thumb, take the time and effort to manage SELinux and <code>firewalld</code> correctly, in this case, to save time and focus on the prerequisites and deployment of OpenShift, disable both:
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Disable SELinux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/sysconfig/selinux</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>SELINUX=disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>Disable firewall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>systemctl stop firewalld
systemctl disable firewalld</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can be configured these later, but the less potential cause of issues the better because troubleshooting can be tricky if numerous problems are in the equation. Get the most basic working deployment complete, then introduce things one at a time making the process of troubleshooting "cause and effect" easier.</p>
</div>
<div class="paragraph">
<p>Install any updates and reboot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum update -y
reboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming the changes made are correct, test the static IP address using SSH from a client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ssh root@192.168.0.101</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dns">DNS</h4>
<div class="paragraph">
<p>Install <code>dnsmasq</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum install dnsmasq -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup the original configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>dnsmasq.conf</code> configuration file includes a few things but a key line to point out is the <code>apps.cluster.lab.com</code> line which provides the wildcard DNS resolution such as <code>foo.apps.cluster.lab.com</code> or <code>bar.apps.cluster.lab.com</code>:</p>
</div>
<div class="paragraph">
<p>Edit dnsmasq.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/dnsmasq.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>server=192.168.0.1
server=8.8.8.8
server=8.8.4.4
local=/cluster.lab.com/
address=/apps.cluster.lab.com/192.168.0.101
interface=eth0
listen-address=::1,127.0.0.1,192.168.0.101
expand-hosts
domain=cluster.lab.com
addn-hosts=/etc/dnsmasq.openshift.hosts
conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig
srv-host=_etcd-server-ssl._tcp.cluster,master1.cluster.lab.com,2380,0,10
srv-host=_etcd-server-ssl._tcp.cluster,master2.cluster.lab.com,2380,0,10
srv-host=_etcd-server-ssl._tcp.cluster,master3.cluster.lab.com,2380,0,10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next I&#8217;m adding all the DNS entire I might ever need for a cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/dnsmasq.openshift.hosts</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>192.168.0.101 utilities.cluster.lab.com dns.cluster.lab.com lb.cluster.lab.com api.cluster.lab.com api-int.cluster.lab.com
192.168.0.102 bootstrap.cluster.lab.com
192.168.0.111 master1.cluster.lab.com etcd-0.cluster.lab.com
192.168.0.112 master2.cluster.lab.com etcd-1.cluster.lab.com
192.168.0.113 master3.cluster.lab.com etcd-2.cluster.lab.com
192.168.0.121 worker1.cluster.lab.com
192.168.0.122 worker2.cluster.lab.com
192.168.0.123 worker3.cluster.lab.com
192.168.0.131 infra1.cluster.lab.com
192.168.0.132 infra2.cluster.lab.com
192.168.0.133 infra3.cluster.lab.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next configure this host to use itself for DNS resolution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/resolv.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>search Home cluster.lab.com
nameserver 192.168.0.101</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lock <code>resolv.conf</code> from being modified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>chattr +i /etc/resolv.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start and enable the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>systemctl enable dnsmasq.service --now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install bind-utils:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum install bind-utils -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test some lookups, both IP Addresses and DNS entries should be resolvable, including <code>anything.apps.cluster.lab.com</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>nslookup www.google.com
nslookup master1.cluster.lab.com
nslookup 192.168.0.111
nslookup foo.apps.cluster.lab.com
nslookup bar.apps.cluster.lab.com</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_haproxy">HAProxy</h4>
<div class="paragraph">
<p>Install HAProxy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum install haproxy -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Back up the original configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</code></pre>
</div>
</div>
<div class="paragraph">
<p>And add the following configuration (changing IPs for your environment)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/haproxy/haproxy.cfg</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>global
    log         127.0.0.1 local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

    stats socket /var/lib/haproxy/stats

defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    30s
    timeout queue           1m
    timeout connect         30s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 30s
    timeout check           30s
    maxconn                 4000

frontend api
    bind 0.0.0.0:6443
    option tcplog
    mode tcp
    default_backend api

backend api
    option httpchk GET /healthz
    http-check expect status 200
    mode tcp
    balance roundrobin
    server bootstrap bootstrap.cluster.lab.com:6443 check check-ssl verify none
    server master1 master1.cluster.lab.com:6443 check check-ssl verify none
    server master2 master2.cluster.lab.com:6443 check check-ssl verify none
    server master3 master3.cluster.lab.com:6443 check check-ssl verify none

frontend api-int
    bind 0.0.0.0:22623
    option tcplog
    mode tcp
    default_backend api-int

backend api-int
    mode tcp
    balance roundrobin
    server bootstrap 192.168.0.102:22623 check
    server master1 192.168.0.111:22623 check
    server master2 192.168.0.112:22623 check
    server master3 192.168.0.113:22623 check

frontend apps-http
    bind 192.168.0.101:80
    option tcplog
    mode tcp
    default_backend apps-http

backend apps-http
    mode tcp
    balance roundrobin
    server master1 master1.cluster.lab.com:80 check
    server master2 master2.cluster.lab.com:80 check
    server master3 master3.cluster.lab.com:80 check

frontend apps-https
    bind 192.168.0.101:443
    option tcplog
    mode tcp
    default_backend apps-https

backend apps-https
    mode tcp
    balance roundrobin
    option ssl-hello-chk
    server master1 192.168.0.111:443 check
    server master2 192.168.0.112:443 check
    server master3 192.168.0.113:443 check

listen stats
    bind 0.0.0.0:9000
    mode http
    balance
    timeout client 5000
    timeout connect 4000
    timeout server 30000
    stats uri /stats
    stats refresh 5s
    stats realm HAProxy\ Statistics
    stats auth admin:changeme
    stats admin if TRUE</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>haproxy.conf</code> example purposely uses inconsistent methods of configuration between the load balancers to provide good working examples. The configuration here is  correct for serving OpenShift requirements. Notice the configuration includes an HAProxy Statistics page that auto-refreshes, and that the <code>apps-http</code> excludes the SSL check.</p>
</div>
<div class="paragraph">
<p>Enable and start HAProxy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>systemctl enable haproxy.service --now</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the graphical statistics report at <a href="http://192.168.0.101:9000/stats" class="bare">http://192.168.0.101:9000/stats</a>. In this example the username is <code>admin</code> and password is <code>changeme</code>. If you&#8217;ve pointed your local client to use <code>192.168.0.101</code> for its DNS, try <a href="http://lb.cluster.lab.com:9000/stats" class="bare">http://lb.cluster.lab.com:9000/stats</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apache_web_server">Apache web server</h4>
<div class="paragraph">
<p>Install and configure <code>httpd</code> on port <code>8080</code> (because port 80 is already used by HAProxy)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>yum install httpd -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>httpd.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi /etc/httpd/conf/httpd.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Listen 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable and start the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>systemctl enable httpd.service --now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to append port <code>8080</code> when referring to this service, for example: <a href="http://192.168.0.101:8080/" class="bare">http://192.168.0.101:8080/</a></p>
</div>
<div class="paragraph">
<p>For OpenShift bare metal installations, files can be copied into <code>/var/www/html</code> on this utilities server.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation">INSTALLATION</h3>
<div class="paragraph">
<p>At the time of writing the latest version is 4.6.4. The downloads necessary are publicly available however download a legitimate pull secret from the Red Hat cluster portal. Vising <a href="https://cloud.redhat.com/openshift/install/metal/user-provisioned" class="bare">https://cloud.redhat.com/openshift/install/metal/user-provisioned</a> for the latest versions and obtaining your pull secret.</p>
</div>
<div class="sect3">
<h4 id="_client_tools">Client tools</h4>
<div class="paragraph">
<p>Download the OpenShift installer program on your client computer:</p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-install-linux.tar.gz" class="bare">https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-install-linux.tar.gz</a></p>
</div>
<div class="paragraph">
<p>Download the OpenShift command-line tools:</p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz" class="bare">https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz</a></p>
</div>
<div class="paragraph">
<p>Checksums:</p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/sha256sum.txt" class="bare">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/sha256sum.txt</a></p>
</div>
<div class="paragraph">
<p>Check the integrity of the downloaded files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sha256sum openshift-client-linux.tar.gz
sha256sum openshift-install-linux.tar.gz</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>c1f39a966fc0dbd4f8f0bfec0196149d54e0330de523bf906bbe2728b10a860b  openshift-client-linux.tar.gz
b81e1d25d77a05eaae8c0f154ed563c2caee21ed63401d655a7ad3206fdfd53c  openshift-install-linux.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make a <code>bin</code> directory in your home directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkdir ~/bin</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may prefer to extract to <code>/usr/local/bin/</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Extract the CLI tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tar -xvf openshift-client-linux.tar.gz -C ~/bin
tar -xvf openshift-install-linux.tar.gz -C ~/bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the <code>oc</code> version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc version</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Client Version: 4.6.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the <code>openshift-install</code> version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>openshift-install version</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>openshift-install 4.6.4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_preparation">Install preparation</h4>
<div class="paragraph">
<p>Create a working directory, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mkdir -p ~/ocp4/cluster &amp;&amp; cd ~/ocp4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate a new SSH key pair that will be embedded into the OpenShift deployment, this will enable you to SSH to OpenShift nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ssh-keygen -t rsa -b 4096 -N '' -f cluster_id_rsa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an installation configuration file, the compute replicas is always set to zero for bare metal, this refers to worker nodes which are manually added post-deployment. The key option here is the <code>controlPlane: replicas</code> needs to be either <code>1</code> for a single node cluster or <code>3</code> for the minimal three node cluster. The bootstrap process does not complete until this defined critical is met, so plan ahead!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi install-config.yaml.orig</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: v1
baseDomain: lab.com
compute:
- hyperthreading: Enabled
  name: worker
  replicas: 0
controlPlane:
  hyperthreading: Enabled
  name: master
  replicas: 3
metadata:
  name: cluster
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
platform:
  none: {}
fips: false
pullSecret: '{"auths": ...}'
sshKey: 'ssh-ed25519 AAAA...'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the configuration file into the cluster directory, it&#8217;s important to have the original copy because the installation process destroys it! It&#8217;s handy to keep for reference and because in reality it usually takes a few attempts to get right.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Remember to paste in your real pull secret and public key.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cp install-config.yaml.orig cluster/install-config.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following two commands create and initiates the installation process. The first create manifests step gives you an opportunity to make further tweak to the deployment. The create ignition-configs uses those manifest to create the ignition files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>openshift-install create manifests --dir=cluster
openshift-install create ignition-configs --dir=cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>The files in the <code>cluster</code> directory should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>auth
bootstrap.ign
master.ign
metadata.json
worker.ign</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dependencies">Dependencies</h4>
<div class="paragraph">
<p>Download the installer ISO image and the compressed metal RAW:</p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-installer.x86_64.iso" class="bare">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-installer.x86_64.iso</a></p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-metal.x86_64.raw.gz" class="bare">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-metal.x86_64.raw.gz</a></p>
</div>
<div class="paragraph">
<p>Checksums:</p>
</div>
<div class="paragraph">
<p><a href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/sha256sum.txt" class="bare">https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/sha256sum.txt</a></p>
</div>
<div class="paragraph">
<p>Check the integrity of the downloaded files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sha256sum rhcos-installer.x86_64.iso
sha256sum rhcos-metal.x86_64.raw.gz</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>d15bd7ae942573eece34ba9c59e110e360f15608f36e9b83ab9f2372d235bef2  rhcos-installer.x86_64.iso
7e61bbe56735bc26d0808d4fffc4ccac25554df7d3c72c7b678e83e56c7ac5ba  rhcos-metal.x86_64.raw.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the three ignition files and the Red Hat CoreOS image to the <code>utilities.cluster.lab.com</code>, to be served by Apache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>scp cluster/*.ign root@192.168.0.101:/var/www/html/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the Red Hat CoreOS image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>scp rhcos-metal.x86_64.raw.gz root@192.168.0.101:/var/www/html/</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <code>utilities.cluster.lab.com</code> ensure file permissions are correct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>chmod 644 /var/www/html/*</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the client computer test these files are available to download via HTTP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>wget http://192.168.0.101:8080/bootstrap.ign</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bootstrap_node">Bootstrap node</h4>
<div class="paragraph">
<p>Using either using Virtual machine manager to create a KVM VM or VirtualBox, create a Virtual Machine with 4 cores, 16GB RAM (16384) and 120GB of storage. This VM will is destroyed after the cluster installation is complete.</p>
</div>
<div class="paragraph">
<p>Using the <code>rhcos-metal.x86_64.raw.gz</code> boot the VM up, until you arrive at a command prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$[core@localhost ~]$</code></pre>
</div>
</div>
<div class="paragraph">
<p>The VM will have an IP Address assigned via DHCP, we need to set a static IP.</p>
</div>
<div class="paragraph">
<p>View current interface IP Address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ip a</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>nmcli con show</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connection</p>
</div>
<div class="paragraph">
<p>Set the IPAddress for the bootstrap node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">nmcli con mod 'Wired Connection' ipv4.method manual ipv4.addresses 192.168.0.102/24 ipv4.gateway 192.168.0.1 ipv4.dns 192.168.0.101 connection.autoconnect yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart Network Manager and bring up the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart NetworkManager
nmcli con up 'Wired Connection'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the CoreOS installer, providing the <code>bootstrap.ign</code> ignition file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo coreos-installer install --ignition-url=http://192.168.0.101:8080/bootstrap.ign /dev/sda --insecure-ignition --copy-network</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the VM with <code>reboot</code>, make sure the VM boots from the hard disk storage (eject the ISO before it boots) or <code>shutdown</code> the VM and remove the CD-ROM from the boot order.</p>
</div>
<div class="paragraph">
<p>Make sure the VM boots up with the correct IP Address previously assigned:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/bootstrap-prompt.png" alt="Bootstrap login prompt">
</div>
</div>
<div class="paragraph">
<p>Once the bootstrap node is up and at the login prompt with the correct IP Address, the VM should provision itself, and eventually come up in the load balancer <a href="http://192.168.0.101:9000/stats" class="bare">http://192.168.0.101:9000/stats</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/bootstrap-lb.png" alt="Bootstrap load balancer">
</div>
</div>
<div class="paragraph">
<p>From a Linux client you should be able to SSH to it using the private key generated earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ssh -i cluster_id_rsa core@192.168.0.102</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the progress on the bootstrap node with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>journalctl -b -f -u release-image.service -u bootkube.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following pods should eventually be up and running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo crictl pods

...Ready               bootstrap-kube-scheduler-bootstrap.cluster.lab.com...
...Ready               bootstrap-kube-controller-manager-bootstrap.cluster.lab.com...
...Ready               bootstrap-kube-apiserver-bootstrap.cluster.lab.com...
...Ready               cloud-credential-operator-bootstrap.cluster.lab.com...
...Ready               bootstrap-cluster-version-operator-bootstrap.cluster.lab.com...
...Ready               bootstrap-machine-config-operator-bootstrap.cluster.lab.com...
...Ready               etcd-bootstrap-member-bootstrap.cluster.lab.com...</code></pre>
</div>
</div>
<div class="paragraph">
<p>List the running containers and tail the logs of any one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo crictl ps

sudo crictl logs &lt;CONTAINER_ID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the the Linux client the following command should return <code>ok</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -X GET https://api.cluster.lab.com:6443/healthz -k</code></pre>
</div>
</div>
<div class="paragraph">
<p>Export the <code>kubeconfig</code> and test getting cluster operators with <code>oc get co</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>export KUBECONFIG=cluster/auth/kubeconfig
oc get co</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll only see the <code>cloud-credential</code> operator is available at this stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                        VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication
cloud-credential            True        False         False      26m
cluster-autoscaler
config-operator
console
csi-snapshot-controller
dns
etcd
...</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All of these tests <strong>MUST</strong> work as documented else it&#8217;s pointless continuing any further.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any other responses or errors mean there are issues with either networking, DNS or Load Balancing configurations. Go back and troubleshoot any issues until you get the expected results at his stage.</p>
</div>
<div class="paragraph">
<p>On your client you can see the progress of the installation and that it&#8217;s moved on a step because api.cluster.lab.com is up and working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>openshift-install --dir=cluster wait-for bootstrap-complete</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>INFO Waiting up to 20m0s for the Kubernetes API at https://api.cluster.lab.com:6443...
INFO API v1.19.0+9f84db3 up
INFO Waiting up to 30m0s for bootstrapping to complete...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bootstrapping process will not complete until all three master nodes have been provisioned.</p>
</div>
</div>
<div class="sect3">
<h4 id="_master_nodes">Master nodes</h4>
<div class="paragraph">
<p>For physical host installations, write the <code>rhcos-installer.x86_64.iso</code> image to a USB pen drive.</p>
</div>
<div class="paragraph">
<p>Use <code>fdisk</code> to identify existing storage devices on your system, then insert the USB pen drive, using <code>fdisk</code> again to identify the device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fdisk -l</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">[ ... output omitted ... ]
Disk /dev/sda: 58.5 GiB, 62763565056 bytes, 122585088 sectors
[ ... output omitted ... ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write the image to the device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>sudo dd if=rhcos-installer.x86_64.iso of=/dev/sda status=progress; sync</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next steps repeat the process of booting the three physical nodes using the Red Hat CoreOS ISO. Make sure to use <code>master.ign</code>, and the right IP Address and hostname for each master node. In the case of an Intel NUC, <code>F10</code> is used to interrupt the host BIOS and select a boot device.</p>
</div>
<div class="sect4">
<h5 id="_master1_cluster_lab_com">master1.cluster.lab.com</h5>
<div class="paragraph">
<p>Using the <code>rhcos-installer.x86_64.iso</code> USB device, boot the VM up, until you arrive at a command prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$[core@localhost ~]$</code></pre>
</div>
</div>
<div class="paragraph">
<p>The VM will have an IP Address assigned via DHCP, we need to set a static IP.</p>
</div>
<div class="paragraph">
<p>View current interface IP Address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ip a</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>nmcli con show</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the IP Address for the bootstrap node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">nmcli con mod 'Wired Connection' ipv4.method manual ipv4.addresses 192.168.0.111/24 ipv4.gateway 192.168.0.1 ipv4.dns 192.168.0.101 connection.autoconnect yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart Network Manager and bring up the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart NetworkManager
nmcli con up 'Wired Connection'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the CoreOS installer, providing the <code>master.ign</code> ignition file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>sudo coreos-installer install --ignition-url=http://192.168.0.101:8080/master.ign /dev/sda --insecure-ignition --copy-network</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the VM with <code>reboot</code>, make sure the VM boots from the hard disk storage (remove the USB/ISO before it boots) or <code>shutdown</code> the VM and remove the CD-ROM from the boot order and power it back on.</p>
</div>
<div class="paragraph">
<p>Hit <code>tab</code> at the RHCOS GRUB menu and add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ip=192.168.0.111::192.168.0.1:255.255.255.0:master1.cluster.lab.com:ens3:none nameserver=192.168.0.101</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unable to provide a screenshot of a physical host GRUB configuration, here is the example when repeating this process for an infra node:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/infra-grub.png" alt="GRUB">
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It&#8217;s unclear why this step is needed but with nodes other than the <code>bootstrap</code> node, this intervention was required. There are better methods for provisioning nodes but this documentation is focused on the most fundamental approach.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Prior to OCP 4.6, all the CoreOS parameters where added at the GRUB stage, for reference here are the original parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">coreos.inst=yes
coreos.inst.install_dev=sda
coreos.inst.image_url=http://192.168.0.101:8080/rhcos-metal.raw.gz
coreos.inst.ignition_url=http://192.168.0.101:8080/master.ign
ip=192.168.0.111::192.168.0.1:255.255.255.0:master1.cluster.lab.com:eno1:none:192.168.0.101
nameserver=192.168.0.101</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_master2_cluster_lab_com">master2.cluster.lab.com</h5>
<div class="paragraph">
<p>Repeat the process for the second master node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">nmcli con mod 'Wired Connection' ipv4.method manual ipv4.addresses 192.168.0.112/24 ipv4.gateway 192.168.0.1 ipv4.dns 192.168.0.101 connection.autoconnect yes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart NetworkManager
nmcli con up 'Wired Connection'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>sudo coreos-installer install --ignition-url=http://192.168.0.101:8080/master.ign /dev/sda --insecure-ignition</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ip=192.168.0.112::192.168.0.1:255.255.255.0:master2.cluster.lab.com:ens3:none nameserver=192.168.0.101</code></pre>
</div>
</div>
<div class="paragraph">
<p>Original bootstrap parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">coreos.inst=yes
coreos.inst.install_dev=sda
coreos.inst.image_url=http://192.168.0.101:8080/rhcos-metal.raw.gz
coreos.inst.ignition_url=http://192.168.0.101:8080/master.ign
ip=192.168.0.112::192.168.0.1:255.255.255.0:master2.cluster.lab.com:eno1:none:192.168.0.101
nameserver=192.168.0.101</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_master3_cluster_lab_com">master3.cluster.lab.com</h5>
<div class="paragraph">
<p>Repeat the process for the third master node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">nmcli con mod 'Wired Connection' ipv4.method manual ipv4.addresses 192.168.0.113/24 ipv4.gateway 192.168.0.1 ipv4.dns 192.168.0.101 connection.autoconnect yes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart NetworkManager
nmcli con up 'Wired Connection'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>sudo coreos-installer install --ignition-url=http://192.168.0.101:8080/master.ign /dev/sda --insecure-ignition</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ip=192.168.0.113::192.168.0.1:255.255.255.0:master3.cluster.lab.com:ens3:none nameserver=192.168.0.101</code></pre>
</div>
</div>
<div class="paragraph">
<p>Original bootstrap parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">coreos.inst=yes
coreos.inst.install_dev=sda
coreos.inst.image_url=http://192.168.0.101:8080/rhcos-metal.raw.gz
coreos.inst.ignition_url=http://192.168.0.101:8080/master.ign
ip=192.168.0.113::192.168.0.1:255.255.255.0:master3.cluster.lab.com:eno1:none:192.168.0.101
nameserver=192.168.0.101</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_completion">Completion</h4>
<div class="paragraph">
<p>Once all three master nodes are provisioning the process can take some time to complete. As indicated by the installer INFO "Waiting up to 40m0s for bootstrapping to complete".</p>
</div>
<div class="paragraph">
<p>The two key things to watch are the load balancers and cluster operators. Once the master node boots up to the login prompt, it will download a bunch of images and do some initial installation, and the host will perform a reboot and come back to the login prompt during this process.</p>
</div>
<div class="paragraph">
<p>Once all load balancers are showing up, and all cluster operators are "Available" the <code>openshift-install</code> should complete and advise removing the bootstrap node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openshift-install --dir=cluster wait-for bootstrap-complete</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">INFO Waiting up to 20m0s for the Kubernetes API at https://api.cluster.lab.com:6443...
INFO API v1.19.0+9f84db3 up
INFO Waiting up to 30m0s for bootstrapping to complete...
INFO It is now safe to remove the bootstrap resources
INFO Time elapsed: 0s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check all nodes are "Ready":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                      STATUS   ROLES           AGE   VERSION
master1.cluster.lab.com   Ready    master,worker   14h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready    master,worker   13h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready    master,worker   13h   v1.19.0+9f84db3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check all operators are available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get co</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication                             4.6.4     True        False         False      8m34s
cloud-credential                           4.6.4     True        False         False      15h
cluster-autoscaler                         4.6.4     True        False         False      13h
config-operator                            4.6.4     True        False         False      13h
console                                    4.6.4     True        False         False      7m35s
csi-snapshot-controller                    4.6.4     True        False         False      13h
dns                                        4.6.4     True        False         False      13h
etcd                                       4.6.4     True        False         False      11h
image-registry                             4.6.4     True        False         False      11h
ingress                                    4.6.4     True        False         False      8m40s
insights                                   4.6.4     True        False         False      13h
kube-apiserver                             4.6.4     True        False         False      11h
kube-controller-manager                    4.6.4     True        False         False      13h
kube-scheduler                             4.6.4     True        False         False      13h
kube-storage-version-migrator              4.6.4     True        False         False      13h
machine-api                                4.6.4     True        False         False      13h
machine-approver                           4.6.4     True        False         False      13h
machine-config                             4.6.4     True        False         False      13h
marketplace                                4.6.4     True        False         False      8m23s
monitoring                                 4.6.4     True        False         False      8m18s
network                                    4.6.4     True        False         False      13h
node-tuning                                4.6.4     True        False         False      13h
openshift-apiserver                        4.6.4     True        False         False      8m55s
openshift-controller-manager               4.6.4     True        False         False      13h
openshift-samples                          4.6.4     True        False         False      8m21s
operator-lifecycle-manager                 4.6.4     True        False         False      13h
operator-lifecycle-manager-catalog         4.6.4     True        False         False      13h
operator-lifecycle-manager-packageserver   4.6.4     True        False         False      8m57s
service-ca                                 4.6.4     True        False         False      13h
storage                                    4.6.4     True        False         False      13h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Power off the bootstrap node (and destroy it) and comment out the node in both the <code>api</code> and <code>api-int</code> load balancers in <code>/etc/haproxy/haproxy.cfg</code>.</p>
</div>
<div class="paragraph">
<p>The load balancers should look like the following screenshots, note that the ingress LB only has two replicas, therefore will show down on one of the nodes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/api-lb.png" alt="API LB">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ingress-lb.png" alt="Ingress LB">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_login">Login</h4>
<div class="paragraph">
<p>During installation and from your client you can access the cluster using the <code>system:admin</code> account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>export KUBECONFIG=cluster/auth/kubeconfig</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
system:admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Login is as <code>kubeadmin</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat cluster/auth/kubeadmin-password</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc login -u kubeadmin -p kLsUd-GkkRt-GwPI7-n2cku  https://api.cluster.lab.com:6443</code></pre>
</div>
</div>
<div class="paragraph">
<p>Login to the OpenShift web console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project openshift-console
oc get routes</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, in a browser <a href="https://console-openshift-console.apps.cluster.lab.com" class="bare">https://console-openshift-console.apps.cluster.lab.com</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting">Troubleshooting</h4>
<div class="sect4">
<h5 id="_single_master">Single master</h5>
<div class="paragraph">
<p>It is possible to deploy a single node "cluster" if defined in the <code>install-config.yaml</code>, however the installation never completes, with operators pending. Apply the following patch for the installation to complete with a single master configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc patch etcd cluster -p='{"spec": {"unsupportedConfigOverrides": {"useUnsupportedUnsafeNonHANonProductionUnstableEtcd": true}}}' --type=merge</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_unknown_authority">Unknown authority</h5>
<div class="paragraph">
<p>The following error can sometimes occur when attempting to login to the API via the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>error: x509: certificate signed by unknown authority</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch projects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project openshift-authentication</code></pre>
</div>
</div>
<div class="paragraph">
<p>List the pods in the <code>openshift-authentication</code> project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using one of the pod names export the ingress certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc rsh -n openshift-authentication oauth-openshift-568bcc5d8f-84zh2 cat /run/secrets/kubernetes.io/serviceaccount/ca.crt &gt; ingress-ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy and update your certificate authority certificates on your client host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo cp ingress-ca.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust extract</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_missing_console">Missing Console</h5>
<div class="paragraph">
<p>If both the <code>openshift-samples</code> and <code>console</code> operators were absent during deployment of a cluster. Powering off all three masters and powering them back on brought all the operators up.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodes">NODES</h3>
<div class="paragraph">
<p>For a home lab, it might be common to leave the cluster as a minimal three-node cluster.  Resources can be tight; however, in the real world, it is likely to provision dedicated infra nodes and many worker nodes.
It is then possible to label nodes accordingly and mark specific applications to only run on designated infrastructure.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Whatever the labelling conventions used, all nodes from this point are "worker" nodes with labels.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_infra_nodes">Infra nodes</h4>
<div class="paragraph">
<p>To avoid duplication just the key details are included, in this case three infra VMs are provisioned with bridged networking, each with 8GB Memory, 2 cores and 50GB storage. Pay close attention to the IP Addresses and the use of the <code>worker.ign</code> ignition file.</p>
</div>
<div class="paragraph">
<p><strong><code>infra1.cluster.lab.com</code></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">nmcli con mod 'Wired Connection' ipv4.method manual ipv4.addresses 192.168.0.131/24 ipv4.gateway 192.168.0.1 ipv4.dns 192.168.0.101 connection.autoconnect yes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart NetworkManager
nmcli con up 'Wired Connection'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>sudo coreos-installer install --ignition-url=http://192.168.0.101:8080/worker.ign /dev/sda --insecure-ignition --copy-network</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ip=192.168.0.131::192.168.0.1:255.255.255.0:infra1.cluster.lab.com:ens3:none nameserver=192.168.0.101</code></pre>
</div>
</div>
<div class="paragraph">
<p>The node should deploy as seen while doing master nodes but worker nodes get provisioned by the masters. Once a worker node has booted up off its hard drive and arrived at the login prompt, they will be a reboot.</p>
</div>
<div class="paragraph">
<p>Check for certificate signing requests, as a cluster administrator view any pending csr:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get csr</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get csr | grep -i pending</code></pre>
</div>
</div>
<div class="paragraph">
<p>Approve them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc adm certificate approve csr-xyz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically, approving the first pending CSR, will cause a second one to appear shortly afterwards.</p>
</div>
<div class="paragraph">
<p>Once both CRS are approved you&#8217;ll see the node with a status NotReady:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                      STATUS     ROLES           AGE   VERSION
infra1.cluster.lab.com    NotReady   worker          25s   v1.19.0+9f84db3
master1.cluster.lab.com   Ready      master,worker   16h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready      master,worker   15h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready      master,worker   14h   v1.19.0+9f84db3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The deployment of the node is still in progress, eventually the node with change status to "Ready".</p>
</div>
<div class="paragraph">
<p>Example when all three infra nodes are initially added to the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                      STATUS     ROLES           AGE   VERSION
infra1.cluster.lab.com    Ready      worker          68s   v1.19.0+9f84db3
infra2.cluster.lab.com    Ready      worker          32m   v1.19.0+9f84db3
infra3.cluster.lab.com    Ready      worker          11m   v1.19.0+9f84db3
master1.cluster.lab.com   Ready      master,worker   16h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready      master,worker   15h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready      master,worker   15h   v1.19.0+9f84db3</code></pre>
</div>
</div>
<div class="paragraph">
<p>You repeat this for any other infra nodes desired, most commonly at least three to achieve high availability, as depicted in the example above.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice the <code>ROLE</code> for the infra node is currently set to <code>worker</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_label_infra_nodes">Label infra nodes</h5>
<div class="paragraph">
<p>Create the infra machine config pool <code>infra-mcp.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  name: infra
spec:
  machineConfigSelector:
    matchExpressions:
      - {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,infra]}
  maxUnavailable: 1
  nodeSelector:
    matchLabels:
      node-role.kubernetes.io/infra: ""
  paused: false</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f infra-mcp.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Label infra nodes and remove worker label:</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The adding of infra label forces a reboot of the node, wait for reboot before removing the worker label
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc label node infra1.cluster.lab.com node-role.kubernetes.io/infra=
oc label node infra2.cluster.lab.com node-role.kubernetes.io/infra=
oc label node infra3.cluster.lab.com node-role.kubernetes.io/infra=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each node will be marked as non-schedulable and reboot in turn:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>watch oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>infra1.cluster.lab.com    Ready,SchedulingDisabled   infra,worker    5m3s   v1.19.0+9f84db3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once completed, each infra node will be labelled both <code>infra,worker</code>, remove the <code>worker</code> label from each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc label node infra1.cluster.lab.com node-role.kubernetes.io/worker-
oc label node infra2.cluster.lab.com node-role.kubernetes.io/worker-
oc label node infra3.cluster.lab.com node-role.kubernetes.io/worker-</code></pre>
</div>
</div>
<div class="paragraph">
<p>Node should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>NAME                      STATUS   ROLES           AGE   VERSION
infra1.cluster.lab.com    Ready    infra           11m   v1.19.0+9f84db3
infra2.cluster.lab.com    Ready    infra           42m   v1.19.0+9f84db3
infra3.cluster.lab.com    Ready    infra           21m   v1.19.0+9f84db3
master1.cluster.lab.com   Ready    master,worker   16h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready    master,worker   15h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready    master,worker   15h   v1.19.0+9f84db3</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_worker_nodes">Worker nodes</h4>
<div class="paragraph">
<p>Add worker nodes by repeating the same process as adding infra nodes without any labelling. Making sure IP Addresses and host names are correct during the process.</p>
</div>
<div class="paragraph">
<p>A typical deployment might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>NAME                      STATUS   ROLES           AGE   VERSION
infra1.cluster.lab.com    Ready    infra           11m   v1.19.0+9f84db3
infra2.cluster.lab.com    Ready    infra           42m   v1.19.0+9f84db3
infra3.cluster.lab.com    Ready    infra           21m   v1.19.0+9f84db3
master1.cluster.lab.com   Ready    master,worker   16h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready    master,worker   15h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready    master,worker   15h   v1.19.0+9f84db3
worker1.cluster.lab.com   Ready    worker          68s   v1.19.0+9f84db3
worker2.cluster.lab.com   Ready    worker          32m   v1.19.0+9f84db3
worker3.cluster.lab.com   Ready    worker          11m   v1.19.0+9f84db3</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_move_ingress_router">Move ingress router</h4>
<div class="paragraph">
<p>It&#8217;s common practice to move the ingress router off the master nodes and run three replicas on the infra nodes. With the correctly labelled infranodes in place this is done with the following two patches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc patch -n openshift-ingress-operator ingresscontroller/default --patch '{"spec":{"nodePlacement": {"nodeSelector":{"matchLabels":{"node-role.kubernetes.io/infra": "" }}}}}' --type=merge</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc patch -n openshift-ingress-operator ingresscontroller/default --patch '{"spec":{"replicas": 3}}' --type=merge</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Update the backend ingress load balancer, in this case, HAProxy, to now point at the three infra nodes.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_disable_master_scheduler">Disable master scheduler</h4>
<div class="paragraph">
<p>Disabling the master scheduler removes the "worker" label from master nodes, preventing unwanted applications from running on master nodes, reserving their resources for running the cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc edit scheduler</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set mastersSchedulable to false:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: config.openshift.io/v1
kind: Scheduler
metadata:
  creationTimestamp: null
  name: cluster
spec:
  mastersSchedulable: false
  policy:
    name: ""
status: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Validate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>NAME                      STATUS   ROLES           AGE   VERSION
infra1.cluster.lab.com    Ready    infra           11m   v1.19.0+9f84db3
infra2.cluster.lab.com    Ready    infra           42m   v1.19.0+9f84db3
infra3.cluster.lab.com    Ready    infra           21m   v1.19.0+9f84db3
master1.cluster.lab.com   Ready    master          16h   v1.19.0+9f84db3
master2.cluster.lab.com   Ready    master          15h   v1.19.0+9f84db3
master3.cluster.lab.com   Ready    master          15h   v1.19.0+9f84db3
worker1.cluster.lab.com   Ready    worker          68s   v1.19.0+9f84db3
worker2.cluster.lab.com   Ready    worker          32m   v1.19.0+9f84db3
worker3.cluster.lab.com   Ready    worker          11m   v1.19.0+9f84db3</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete_nodes">Delete nodes</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>oc delete node infra1.cluster.lab.com</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ntpchrony">NTP/CHRONY</h3>
<div class="paragraph">
<p>In a lab environment, <code>chronyd</code> will be already configured on nodes with the default <code>pool 2.rhel.pool.ntp.org iburst</code>. Should the configuration need to be changed, the process involves adding MachineConfig. Machine Configs are found via the Web Console under <strong>Compute &#8594; Machine Config</strong>. Think of Machine Configs as configuration management for the cluster.</p>
</div>
<div class="paragraph">
<p>SSH to a master node and switch to root, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">ssh -i cluster_id_rsa core@192.168.0.111
sudo su -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get a working minimalistic <code>chrony.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">grep -v -e '^#' -e '^$' /etc/chrony.conf &gt; chrony.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>On a client make a copy of the <code>chrony.conf</code> configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi chrony.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">pool 2.rhel.pool.ntp.org iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony</code></pre>
</div>
</div>
<div class="paragraph">
<p>Encoded the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">base64 chrony.conf &gt; chrony.conf.encoded</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a MachineConfig for worker nodes, pasting in the chrony.conf.encoded content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi worker-chrony.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: worker-chrony
spec:
  config:
    ignition:
      version: 2.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,cG9vbCAyLnJoZWwucG9vbC5udHAub3JnIGlidXJzdApkcmlmdGZpbGUgL3Zhci9saWIvY2hyb255L2RyaWZ0Cm1ha2VzdGVwIDEuMCAzCnJ0Y3N5bmMKa2V5ZmlsZSAvZXRjL2Nocm9ueS5rZXlzCmxlYXBzZWN0eiByaWdodC9VVEMKbG9nZGlyIC92YXIvbG9nL2Nocm9ueQo=
          verification: {}
        filesystem: root
        mode: 0644
        path: /etc/chrony.conf</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Applying the configuration causes nodes to schedule a reboot, expect each worker node to bounce in sequence.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">watch oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f worker-chrony.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And repeat for master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi master-chrony.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: master-chrony
spec:
  config:
    ignition:
      version: 2.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,cG9vbCAyLnJoZWwucG9vbC5udHAub3JnIGlidXJzdApkcmlmdGZpbGUgL3Zhci9saWIvY2hyb255L2RyaWZ0Cm1ha2VzdGVwIDEuMCAzCnJ0Y3N5bmMKa2V5ZmlsZSAvZXRjL2Nocm9ueS5rZXlzCmxlYXBzZWN0eiByaWdodC9VVEMKbG9nZGlyIC92YXIvbG9nL2Nocm9ueQo=
          verification: {}
        filesystem: root
        mode: 0644
        path: /etc/chrony.conf</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Remeber, applying the configuration causes nodes to schedule a reboot, expect each master node to bounce in sequence.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f master-chrony.yaml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_image_registry">IMAGE REGISTRY</h3>
<div class="paragraph">
<p>In typical OpenShift deployments, using a cloud provider with credentials, storage classes will be made available for the target infrastructure. In a bare-metal situation, this is not a luxury. It is simple to define NFS for shared storage, which is OK for specific services and tasks but something like logging; performance will take a hit.
It is possible to add physical block devices to nodes and use the "Local Storage Operator". However, local storage volumes are fixed to nodes, so moving pods that depend on block storage will run into difficulties, not being able to mount storage to different nodes on demand.</p>
</div>
<div class="paragraph">
<p>For the image registry, NFS shared storage is the right choice.</p>
</div>
<div class="sect3">
<h4 id="_nfs_server">NFS server</h4>
<div class="paragraph">
<p>Using a RHEL/CentOS 8.2 host on the same network as your OpenShift Cluster install <code>nfs-utils</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">sudo dnf install nfs-utils -y</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">systemctl start nfs-server
systemctl enable nfs-server
systemctl status nfs-server</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">sudo mkdir -p /mnt/openshift/registry</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi /etc/exports</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following, including the options for <code>rw,no_wdelay,no_root_squash</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">/mnt/openshift/registry         192.168.0.1/24(rw,sync,no_wdelay,no_root_squash,insecure)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Export the new share with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">exportfs -arv</code></pre>
</div>
</div>
<div class="paragraph">
<p>And confirm the share is visible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">exportfs  -s
showmount -e 127.0.0.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If required, open up the firewall ports needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">firewall-cmd --permanent --add-service=nfs
firewall-cmd --permanent --add-service=rpc-bind
firewall-cmd --permanent --add-service=mountd
firewall-cmd --reload</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nfs_storage_class">NFS storage class</h4>
<div class="paragraph">
<p>Add a storage class with the no-provisioner option, making it a manual process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi nfs-storage-class.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs
provisioner: no-provisioner
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f nfs-storage-class.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>See storage classes via the web console <strong>Storage &#8594; Storage Classes</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">Configuration</h4>
<div class="paragraph">
<p>You can now add persistent volume(s) (PV) using the <code>nfs</code> storage class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi registry-pv.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: v1
kind: PersistentVolume
metadata:
  name: registry-pv
spec:
  capacity:
    storage: 50Gi
  accessModes:
  - ReadWriteMany
  nfs:
    path: /mnt/openshift/registry
    server: 192.168.0.15
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f registry-pv.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And view the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
registry-pv   50Gi       RWX            Retain           Available           nfs                     3s</code></pre>
</div>
</div>
<div class="paragraph">
<p>To update the registry storage, you can add a persistent volume claim (PVC) using the new NFS storage class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi registry-pvc.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: image-registry-storage
  namespace: openshift-image-registry
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 50Gi
  storageClassName: nfs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f registry-pvc.yaml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The default name for the pvc created is <code>image-registry-storage</code> which is a known here.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Switch to the <code>openshift-image-registry</code> project and view the pending PVC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-image-registry
oc get pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will be currently pending:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                     STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
image-registry-storage   Pending                                      nfs            15s</code></pre>
</div>
</div>
<div class="paragraph">
<p>And edit the image registry configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc edit configs.imageregistry.operator.openshift.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>Three things need changing under <code>spec:</code> include <code>managementState</code>, <code>replicas</code> and <code>storage</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">...
  managementState: Managed
...
...
  replica: 3
...
...
  storage:
    pvc:
      claim: image-registry-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the state/progress of these changes by viewing the pods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-image-registry
oc get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                                               READY   STATUS      RESTARTS   AGE
cluster-image-registry-operator-6c55f65c7d-sst5g   2/2     Running     0          18h
image-pruner-1605225600-cpm8d                      0/1     Completed   0          10h
image-registry-659c75894d-28mp4                    1/1     Running     0          18h
image-registry-659c75894d-5mx25                    1/1     Running     0          18h
image-registry-659c75894d-zqxcq                    1/1     Running     0          18h
node-ca-vj6ql                                      1/1     Running     0          3d
node-ca-wjk57                                      1/1     Running     0          3d
node-ca-ww946                                      1/1     Running     0          3d</code></pre>
</div>
</div>
<div class="paragraph">
<p>And see the PVC has been claimed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pvc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                     STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS
image-registry-storage   Bound    registry-pv   50Gi       RWX            nfs</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_expose_registry">Expose registry</h4>
<div class="paragraph">
<p>Finally, you can expose the OpenShift image registry to enable you to work with it using Docker or Podman to tag and push images, make sure your in the <code>openshift-image-registry</code> project or add <code>-n openshift-image-registry</code> to include namespace with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc patch configs.imageregistry.operator.openshift.io/cluster --patch '{"spec":{"defaultRoute":true}}' --type=merge</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get routes</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_migrate_registry">Migrate registry</h4>
<div class="paragraph">
<p>To move the image registry to run on infra nodes apply the follwoing patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc patch configs.imageregistry.operator.openshift.io/cluster -n openshift-image-registry --type=merge --patch '{"spec":{"nodeSelector":{"node-role.kubernetes.io/infra":""}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check where pods are running by adding <code>-o wide</code> to the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pods -o wide</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_2">Troubleshooting</h4>
<div class="sect4">
<h5 id="_no_route_to_host">No route to host</h5>
<div class="paragraph">
<p>If pods never get past <code>ContainerCreating</code>, use <code>oc describe pod</code> to see details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-image-registry
oc get pods
oc describe pod image-registry-5cc87cc5b8-4k6l6</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">mount.nfs: No route to host</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s either the PV is is configured incorrectly, pointing to a wrong NFS server or the NFS server/share is being blocked by a firewall or unavailable.</p>
</div>
</div>
<div class="sect4">
<h5 id="_unexpected_status">Unexpected status</h5>
<div class="paragraph">
<p>If you see errors with OpenShift deployments later like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Registry server Address:
Registry server User Name: serviceaccount
Registry server Email: serviceaccount@example.org
Registry server Password: &lt;&lt;non-empty&gt;&gt;
error: build error: Failed to push image: error copying la... received unexpected HTTP status: 500 Internal Server Error</code></pre>
</div>
</div>
<div class="paragraph">
<p>The permissions on the share directory need fixing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">chmod 775 /mnt/openshift/registry</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_undo_storage_config">Undo storage config</h5>
<div class="paragraph">
<p>If you need to revert back to a known working configuration, you can make it ephemeral by replacing the registry storage with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc edit configs.imageregistry.operator.openshift.io</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">  storage:
    emptyDir: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete PVC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc delete pvc image-registry-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete PV:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc delete pv registry-pv</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_local_storage">LOCAL STORAGE</h3>
<div class="paragraph">
<p>Using the local storage operator deals with adding real disks, block storage to nodes.</p>
</div>
<div class="paragraph">
<p>Prior to OCP 4.6, a project needed to be created manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc new-project local-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable local storage on all nodes including masters and infras:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc annotate project local-storage openshift.io/node-selector=''</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to <strong>Operators → OperatorHub</strong>, type "Local Storage" into the filter box to locate the Local Storage Operator which now creates <code>openshift-local-storage</code> project namespace.</p>
</div>
<div class="sect3">
<h4 id="_local_storage_class">Local storage class</h4>
<div class="paragraph">
<p>Like with NFS, next create a new custom storage class for local block storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi local-storage-class.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-sc
provisioner: no-provisioner
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
parameters:
  diskformat: thin</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f local-storage-class.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>See storage classes via the web console <strong>Storage → Storage Classes</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_block_storage">Adding block storage</h4>
<div class="paragraph">
<p>Adding disks to servers is either physical activity, or a simple case of adding disks to VMs in which ever virtualization in use.</p>
</div>
<div class="paragraph">
<p>Once block storage is added, determine the device paths for the new devices, SSH to each node and use <code>fdisk -l</code> to see devices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">ssh -i cluster_id_rsa core@192.168.0.111
sudo fdisk -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commonly, new devices will begin with <code>/dev/sdb</code> (<code>sda</code> used by RHCOS).</p>
</div>
<div class="paragraph">
<p>Its good practice to manage each node because paths might differ depending on the environment.</p>
</div>
<div class="paragraph">
<p>Assuming three infra nodes, each with a new 50GB disk attached, here is infra1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi local-disks-infra1.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: "local.storage.openshift.io/v1"
kind: "LocalVolume"
metadata:
  name: "local-disks-i1"
  namespace: "openshift-local-storage"
spec:
  nodeSelector:
    nodeSelectorTerms:
    - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - infra1.cluster.lab.com
  storageClassDevices:
    - storageClassName: "local-sc"
      volumeMode: Filesystem
      fsType: xfs
      devicePaths:
        - /dev/sdb</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f local-disks-infra1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a short time, see the PVs appear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM STORAGECLASS   REASON   AGE
local-pv-297ca047   50Gi       RWO            Retain           Available         local-sc                53s
local-pv-dc609890   50Gi       RWO            Retain           Available         local-sc                63s
local-pv-fe609342   50Gi       RWO            Retain           Available         local-sc                70s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Navigate to <strong>Administration &#8594; Custom Resource Definitions &#8594; LocalVolume &#8594; Instances</strong> to view Local Volumes.</p>
</div>
<div class="paragraph">
<p>Repeat this process for each node in the cluster that needs local block storage made available.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cluster_logging">CLUSTER LOGGING</h3>
<div class="paragraph">
<p>OpenShift comes with its native logging stack using Elasticsearch, Fluentd, and Kibana (EFK). It can be very resource-intensive, in a production environment dedicate resource plentiful "infra" nodes to run Elasticsearch and use decent block storage.</p>
</div>
<div class="paragraph">
<p>Making do with limited resources for home lab environments.</p>
</div>
<div class="paragraph">
<p>Install the "Elastic Search" and "Cluster Logging" operators via the Web Console, See <a href="https://docs.openshift.com/container-platform/4.6/logging/cluster-logging-deploying.html" class="bare">https://docs.openshift.com/container-platform/4.6/logging/cluster-logging-deploying.html</a></p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Make sure you select operators provided by Red Hat, Inc and not proprietary or community versions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check the current state of the cluster-logging project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-logging</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                                       READY   STATUS    RESTARTS   AGE
cluster-logging-operator-f58c98989-2jrxx   1/1     Running   0          28m</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_ephemeral_logging">Ephemeral logging</h4>
<div class="paragraph">
<p>To run logging with ephemeral storage, meaning all of a pod’s data is lost upon restart because no real storage is provided, perfect for a lab.</p>
</div>
<div class="paragraph">
<p>Via the web console, <strong>Administration → Custom Resource Definitions → ClusterLogging → Instances → Create ClusterLogging</strong>.</p>
</div>
<div class="paragraph">
<p>Make note of the <code>resources: limits:</code>, The following example has reduced memory defined and <code>emptyDir: {}</code> for storage, <code>nodeSelector</code> can be omitted if no infra nodes are defined.</p>
</div>
<div class="paragraph">
<p>Paste in the following logging instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogging"
metadata:
  name: "instance"
  namespace: "openshift-logging"
spec:
  managementState: "Managed"
  logStore:
    type: "elasticsearch"
    retentionPolicy:
      application:
        maxAge: 1d
      infra:
        maxAge: 7d
      audit:
        maxAge: 7d
    elasticsearch:
      nodeCount: 3
      nodeSelector:
        node-role.kubernetes.io/infra: ''
      storage:
        emptyDir: {}
      redundancyPolicy: "SingleRedundancy"
      resources:
        limits:
          memory: 3Gi
        requests:
          memory: 3Gi
  visualization:
    type: "kibana"
    kibana:
      replicas: 1
  curation:
    type: "curator"
    curator:
      schedule: "30 3 * * *"
  collection:
    logs:
      type: "fluentd"
      fluentd: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A working deployment should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-logging
oc get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                                            READY   STATUS    RESTARTS   AGE
cluster-logging-operator-f58c98989-2jrxx        1/1     Running   0          53m
elasticsearch-cdm-2p9fwrm5-1-8fff599cb-j7xh2    2/2     Running   0          3m4s
elasticsearch-cdm-2p9fwrm5-2-944758ff6-zrv9p    2/2     Running   0          3m1s
elasticsearch-cdm-2p9fwrm5-3-68bfc4b584-vbdqp   2/2     Running   0          2m58s
fluentd-bzmw4                                   1/1     Running   0          3m11s
fluentd-msv2p                                   1/1     Running   0          3m11s
fluentd-sglqw                                   1/1     Running   0          3m12s
kibana-86f69c8b84-62b7r                         2/2     Running   0          3m7s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fluentd runs an instance on every node in the cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="_local_storage_logging">Local storage logging</h4>
<div class="paragraph">
<p>Assuming the PVs are available with a storage class of <code>local-sc</code> as described in the #_local_storage_operator section of this document. The following logging instance includes the storage class definition. Both the <code>storageClassName</code> and <code>size</code> are added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogging"
metadata:
  name: "instance"
  namespace: "openshift-logging"
spec:
  managementState: "Managed"
  logStore:
    type: "elasticsearch"
    retentionPolicy:
      application:
        maxAge: 1d
      infra:
        maxAge: 7d
      audit:
        maxAge: 7d
    elasticsearch:
      nodeCount: 3
      nodeSelector:
        node-role.kubernetes.io/infra: ''
      storage:
        storageClassName: local-sc
        size: 50G
      redundancyPolicy: "SingleRedundancy"
      resources:
        limits:
          memory: 3Gi
        requests:
          memory: 3Gi
  visualization:
    type: "kibana"
    kibana:
      replicas: 1
  curation:
    type: "curator"
    curator:
      schedule: "30 3 * * *"
  collection:
    logs:
      type: "fluentd"
      fluentd: {}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-logging
oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>If successful, the PVC should be claimed and bound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pvc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                                         STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE
elasticsearch-elasticsearch-cdm-lk4f9958-1   Bound    local-pv-d4d267e6   50Gi       RWO            local-sc       22s
elasticsearch-elasticsearch-cdm-lk4f9958-2   Bound    local-pv-297ca047   50Gi       RWO            local-sc       22s
elasticsearch-elasticsearch-cdm-lk4f9958-3   Bound    local-pv-6317e505   50Gi       RWO            local-sc       22s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_3">Troubleshooting</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-logging
oc get pods</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_insufficient_memory">Insufficient memory</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc describe pod elasticsearch-cdm-uz12dkcd-1-6cf9ff6cb9-945gg</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Events:
  Type     Reason            Age   From               Message
  ----     ------            ----  ----               -------
  Warning  FailedScheduling  33m   default-scheduler  0/6 nodes are available: 3 Insufficient memory, 3 node(s) didn't match node selector.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resource limits set for elasticsearch must be available on the nodes, either increase memory on the hosts or decrease the memory in the settings.</p>
</div>
</div>
<div class="sect4">
<h5 id="_delete_cluster_logging">Delete cluster logging</h5>
<div class="paragraph">
<p><strong>Administration → Custom Resource Definitions → ClusterLogging → Instances → Create ClusterLogging</strong></p>
</div>
<div class="paragraph">
<p>Delete the cluster logging instance.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_certificates">CERTIFICATES</h3>
<div class="paragraph">
<p>Replicate a local Certificate Authority (CA) for generating SSL certificates and applying them to OpenShift. The first step is to generate a root certificate and a private key. Then add the root certificate to any host, and then certificates generated and signed will be inherently trusted.</p>
</div>
<div class="sect3">
<h4 id="_local_ca">Local CA</h4>
<div class="paragraph">
<p>On a local Linux client, Generate a private key, you&#8217;ll be prompted for a pass phrase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl genrsa -des3 -out local_ca.key 2048</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Generating RSA private key, 2048 bit long modulus (2 primes)
.............+++++
.......................................................................................................................+++++
e is 65537 (0x010001)
Enter pass phrase for local_ca.key: changeme
Verifying - Enter pass phrase for local_ca.key: changeme</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which generated a private key file <code>local_ca.key</code>.</p>
</div>
<div class="paragraph">
<p>Generate a root certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl req -x509 -new -nodes -key local_ca.key -sha256 -days 1825 -out local_ca.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password you just set and I used the following bogus details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Country Name (2 letter code) [XX]:UK
State or Province Name (full name) []:CA County
Locality Name (eg, city) [Default City]:CA City
Organization Name (eg, company) [Default Company Ltd]:Local Certificate Authority
Organizational Unit Name (eg, section) []:CA Unit
Common Name (eg, your name or your server's hostname) []:ca.local
Email Address []:noreply@ca.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>View root certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl x509 -in local_ca.pem --text</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_root_certificate">Install root certificate</h4>
<div class="paragraph">
<p>On a local Linux RHEL 8/CentOS 8 client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">sudo cp local_ca.pem /etc/pki/ca-trust/source/anchors/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">update-ca-trust extract</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_signed_certificate">Signed certificate</h4>
<div class="paragraph">
<p>Create a private key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl genrsa -out cluster.lab.com.key 2048</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a CSR, with a Common Name (CN) in this case <code>c`luster.lab.com</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl req -new -key cluster.lab.com.key -out cluster.lab.com.csr</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This example relies on the <code>alt_names</code>, you might wish to create two certificates with the Common Names <code>*.apps.cluster.lab.com</code> and <code>api.cluster.lab.com</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Country Name (2 letter code) [XX]:UK
State or Province Name (full name) []:OCP County
Locality Name (eg, city) [Default City]:OCP City
Organization Name (eg, company) [Default Company Ltd]:OpenShift Container Platform
Organizational Unit Name (eg, section) []:OCP Unit
Common Name (eg, your name or your server's hostname) []:cluster.lab.com
Email Address []:noreply@cluster.lab.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a configuration file needed to define the Subject Alternative Name (SAN) extension, this allows multiple, alternative DNS validations. For OpenShift there are two required, one for the ingress traffic for users to access application deployed. The second is for the API. This method means the one certificate can be used for both cases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi cluster.lab.com.ext</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = *.apps.cluster.lab.com
DNS.2 = api.cluster.lab.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the certificate, you&#8217;ll be prompted for the root certificate password again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl x509 -req -in cluster.lab.com.csr -CA local_ca.pem -CAkey local_ca.key -CAcreateserial -out cluster.lab.com.crt -days 825 -sha256 -extfile cluster.lab.com.ext</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have all these files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">cluster.lab.com.crt
cluster.lab.com.csr
cluster.lab.com.ext
cluster.lab.com.key
local_ca.key
local_ca.pem
local_ca.srl</code></pre>
</div>
</div>
<div class="paragraph">
<p>An addition recommended, yet optional step is the add the root certificate at the end of the new client certificate file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">cat local_ca.pem &gt;&gt; cluster.lab.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the final certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl x509 -in cluster.lab.com.crt -text</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl verify -CAfile local_ca.pem cluster.lab.com.crt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">cluster.lab.com.crt: OK</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ingress_certificate">Ingress certificate</h4>
<div class="paragraph">
<p>Create a secret in the <strong><code>openshift-ingress</code></strong> name-space containing both the certificate and private key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create secret tls apps-cert --cert=cluster.lab.com.crt --key=cluster.lab.com.key -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>And apply the patch, make sure the name matches the name of the secret just added, in this case <code>apps-cert</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc patch ingresscontroller.operator default --type=merge -p '{"spec":{"defaultCertificate": {"name": "apps-cert"}}}' -n openshift-ingress-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the changes taking place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the two route pods rebuild:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">NAME                             READY   STATUS    RESTARTS   AGE
router-default-8d9fbbfb7-55xpt   1/1     Running   0          102s
router-default-8d9fbbfb7-w6zhn   1/1     Running   0          118s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_api_certificate">API certificate</h4>
<div class="paragraph">
<p>Create a secret in the <strong><code>openshift-config</code></strong> name-space containing both the certificate and private key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create secret tls api-cert --cert=cluster.lab.com.crt --key=cluster.lab.com.key -n openshift-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, apply the patch, making sure the name matches the name of the secret just added, in this case <code>api-cert</code>, and the domain matches you API URL in this case <code>api.cluster.lab.com</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc patch apiserver cluster --type=merge -p '{"spec":{"servingCerts": {"namedCertificates":[{"names": ["api.cluster.lab.com"], "servingCertificate": {"name": "api-cert"}}]}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see the effect of the previous patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get apiserver cluster -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">spec:
  servingCerts:
    namedCertificates:
    - names:
      - api.cluster.lab.com
      servingCertificate:
        name: api-cert</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the changes taking place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc project openshift-kube-apiserver
oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see three <code>kube-apiserver</code> pods redeploy (this took a while for me):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kube-apiserver-master1.cluster.lab.com       4/4     Running     0          3m58s
kube-apiserver-master2.cluster.lab.com       4/4     Running     0          10m
kube-apiserver-master3.cluster.lab.com       4/4     Running     0          7m11s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all three pods have complete redeployment, check and validate the certificate has been applied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl s_client -connect api.cluster.lab.com:6443</code></pre>
</div>
</div>
<div class="paragraph">
<p>And/or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">curl -vvI https://api.cluster.lab.com:6443</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes the trusted certs on a client doesn&#8217;t take full effect, you can provide the CA certificate explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">curl --cacert local_ca.pem -vvI https://api.cluster.lab.com:6443</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test logging in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc login -u admin -p changme https://api.cluster.lab.com:6443</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another trick is to specify your certificate-authority certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc login --certificate-authority=ca.crt https://api.cluster.lab.com:6443</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_replace_certificates">Replace certificates</h4>
<div class="paragraph">
<p>To replace certificates the following commands can be used:</p>
</div>
<div class="paragraph">
<p>Example for ingress (*.apps):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create secret tls apps-cert --cert=api.cluster.lab.com.crt --key=api.cluster.lab.com.key -n openshift-ingress --dry-run=client -o yaml| oc replace -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example for api:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create secret tls api-cert --cert=api.cluster.lab.com.crt --key=api.cluster.lab.com.key -n openshift-config --dry-run=client -o yaml| oc replace -f -</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_add_ca_bundle">Add CA Bundle</h4>
<div class="paragraph">
<p>Using your CA certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi user-ca-bundle.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: v1
data:
  ca-bundle.crt: |
    -----BEGIN CERTIFICATE-----
    MIIEKTCCAxGgAwIBAgIUTO5Cn1LKQtoaWrfcOnHSdRBmpvwwDQYJKoZIhvcNAQEL
    BQAwgaMxCzAJBgNVBAYTAlVLMRMwEQYDVQQIDApPQ1AgQ291bnR5MREwDwYDVQQH
    DAhPQ1AgQ2l0eTElMCMGA1UECgwcT3BlblNoaWZ0IENvbnRhaW5lciBQbGF0Zm9y
    bTERMA8GA1UECwwIT0NQIFVuaXQxETAPBgNVBAMMCGNhLmxvY2FsMR8wHQYJKoZI
    hvcNAQkBFhBub3JlcGx5QGNhLmxvY2FsMB4XDTIwMTExMjE1NDYxNVoXDTI1MTEx
    MTE1NDYxNVowgaMxCzAJBgNVBAYTAlVLMRMwEQYDVQQIDApPQ1AgQ291bnR5MREw
    DwYDVQQHDAhPQ1AgQ2l0eTElMCMGA1UECgwcT3BlblNoaWZ0IENvbnRhaW5lciBQ
    bGF0Zm9ybTERMA8GA1UECwwIT0NQIFVuaXQxETAPBgNVBAMMCGNhLmxvY2FsMR8w
    HQYJKoZIhvcNAQkBFhBub3JlcGx5QGNhLmxvY2FsMIIBIjANBgkqhkiG9w0BAQEF
    AAOCAQ8AMIIBCgKCAQEAuSidKVFVoKFv3QBHTTgjfhPyvsL4O8H530ehb7iap71b
    Bw2bzxSnrB84Vh4EeZ+pF4cAfK8jquvq2kJjPOGzuflc0aAVWzq6DYJLGRP5T6Sw
    v8Zzlnf0EwSBQRxKs3MNlfM36uRkJMsTxxlKYsBsMP51bT9PNYzPqQ6WcDZyclf+
    OGhnb2uUDud9oGLVapeHfibiyfSahgnnds3UyjWtYUP3sgWDPCKOpXIqFGcCqdfs
    rgRndEq6Leu3/yxnxNwQmB5v3+XAUybUSU8U+cJDYrsyxu5wtYDI75Eo6ocIbVxx
    T+waMwQPLhzMv8YfhNn91l4S0lHR5GL1c7RY3ms+xQIDAQABo1MwUTAdBgNVHQ4E
    FgQURK6H+pSQSQqce0NyZiEbVjbCdukwHwYDVR0jBBgwFoAURK6H+pSQSQqce0Ny
    ZiEbVjbCdukwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAhMRz
    F+e6pV7eQXyyiExIMoTI3hqubsRTANmNbXkNBrCRswUoe7T1F3146G9B2wAFQAtH
    vda4NcS+i1yW4QG0cgnfJRcPsRnTSEmezia4aHn7vUW3oA8HGL47zc+tlQPV6EKd
    hjtdH8R2GIB5CeBhEp1I9DuX2owWEemAnrZxfGjQJxTvCEOprkCJBzozNumwMhZZ
    gmzBUeKYbQHVH0oGATGqKph8X36NGPtUdIDY80INThMS0XvvH7fndX1HOEuB37mn
    UW7CPsnoMWXf8SsPon4g6aMuKsDpKUqsuvT3RNFHofZIBnqXdCYzbdYbzrZ5ppBH
    sx3KXS6+lZijVVMwoA==
    -----END CERTIFICATE-----
kind: ConfigMap
metadata:
  name: user-ca-bundle
  namespace: openshift-config</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f user-ca-bundle.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now edit the cluster proxy configuration (even though a proxy might not be in use):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc edit proxy/cluster</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This causes a scheduled reboot of all your nodes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Replace the <code>spec:</code> with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">spec:
  trustedCA:
    name: user-ca-bundle</code></pre>
</div>
</div>
<div class="paragraph">
<p>This change is a Machine Config and adds the bundle to each nodes <code>ca-trust</code>:</p>
</div>
<div class="paragraph">
<p>SSH to a node, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">ssh -i cluster_id_rsa core@192.168.0.111
sudo su -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following file gets updated with your certificates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">/etc/pki/ca-trust/source/anchors/openshift-config-user-ca-bundle.crt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">openssl x509 -in openshift-config-user-ca-bundle.crt --text</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all the nodes reboot your ca-bundle is included.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_identity_providers">IDENTITY PROVIDERS</h3>
<div class="paragraph">
<p>It is essential to break down OpenShift components and concepts into digestible chunks and avoid the risk of being overwhelmed with complexity.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Identity provider deals with the <strong>authentication</strong> layer and is responsible for identifying a user.</p>
</li>
<li>
<p>The <strong>authorisation</strong> layer determines if requests are honoured, Role-based access control (RBAC) policy determines what a user is authorised to do.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The combination of groups and roles deals with <strong>authorisation</strong>.</p>
</div>
<div class="sect3">
<h4 id="_htpasswd">HTPasswd</h4>
<div class="paragraph">
<p>On a Linux client install the tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">dnf install httpd-tools -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an HTPasswd file containing users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">htpasswd -c -B -b users.htpasswd admin changeme
htpasswd -b users.htpasswd tom changeme
htpasswd -b users.htpasswd dick changeme
htpasswd -b users.htpasswd harry changeme</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">cat users.htpasswd</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">admin:$2y$05$GTvOfcm2An9XdAIyDtwzGOvjGrroac78.NHrDdySO0KOBKAPaYGgi
tom:$apr1$kouuYCYa$wlB2AB4.Ykxn/4QgHUtD9.
dick:$apr1$IETeTG0v$g0P0gqR6aQJTCaGS15QWa0
harry:$apr1$qhyrJZzc$HBCYSf9OFHRpM6he0LJ9k.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command runs locally and generates the needed yaml file for OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create secret generic htpasswd-secret --from-file=htpasswd=users.htpasswd -n openshift-config -o yaml --dry-run=client &gt; htpasswd-secret.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which can then be used to create or replace the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc create -f htpasswd-secret.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc replace -f htpasswd-secret.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For reference, is you wish to extract an existing htpasswd file out of OpenShift use the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc get secret htpasswd-secret -ojsonpath={.data.htpasswd} -n openshift-config | base64 -d &gt; test.htpasswd</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, either via the web console, <strong>Administration &#8594; Cluster Settings &#8594; Global Configuration &#8594; OAuth &#8594; YAML</strong></p>
</div>
<div class="paragraph">
<p>Or via the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi oauth.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: htpasswd_provider
    mappingMethod: claim
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpasswd-secret</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc replace -f oauth.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cluster_admin">Cluster admin</h4>
<div class="paragraph">
<p>Using RBAC to add the role <code>cluster-admin</code> to the new admin account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc adm policy add-cluster-role-to-user cluster-admin admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the account has not being used to log into the cluster a warning will display:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">Warning: User 'admin' not found
clusterrole.rbac.authorization.k8s.io/cluster-admin added: "admin"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Log into OpenShift for each user first to "create the user" in OpenShift and avoid the warning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc adm policy add-cluster-role-to-user edit tom</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">clusterrole.rbac.authorization.k8s.io/edit added: "tom"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add users limited to projects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc adm policy add-role-to-user edit harry -n logging-sensitive-data</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_remove_kubeadmin">Remove kubeadmin</h4>
<div class="paragraph">
<p>OpenShift clusters are deployed with an install generated <code>kubeadmin</code> account. Once identity providers are fully configured it is recommend security best practice to remove this default account.</p>
</div>
<div class="paragraph">
<p>The <code>kubeadmin</code> password is stored in <code>cluster/auth/kubeadmin-password</code>.</p>
</div>
<div class="paragraph">
<p>Ensuring you have added at least one other user with <code>cluster-admin</code> role, the <code>kubeadmin</code> account can be removed using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">oc delete secrets kubeadmin -n kube-system</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ldap">LDAP</h4>
<div class="sect4">
<h5 id="_deploy_ldap">Deploy LDAP</h5>
<div class="paragraph">
<p>This process covers deploying an application using container images. In this case deploying a basic LDAP service for testing identity providers. Such a service would always be external to the cluster. Using this image by Rafael Römhild here <a href="https://github.com/rroemhild/docker-test-openldap" class="bare">https://github.com/rroemhild/docker-test-openldap</a></p>
</div>
<div class="paragraph">
<p>On another host on the same subnet as the cluster and load balancer, pull the image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">podman pull docker.io/rroemhild/test-openldap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">podman pod create -p 389 -p 636 -n ldappod</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If you see an error error from <code>slirp4netns while setting up port redirection: map[desc:bad request: add_hostfwd: slirp_add_hostfwd failed]</code> you need to add the following kernel parameter
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">vi /etc/sysctl.conf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">net.ipv4.ip_unprivileged_port_start = 0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">sudo sysctl -p</code></pre>
</div>
</div>
<div class="paragraph">
<p>Launch the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">podman run --privileged -d --pod ldapod rroemhild/test-openldap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the firewall ports for LDAP for accessing it directly from external hosts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">firewall-cmd --permanent --add-port=389/tcp
firewall-cmd --permanent --add-port=636/tcp
firewall-cmd --reload</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">SUMMARY</h3>
<div class="paragraph">
<p>This document is likely to be updated and evolve. I hope the information and examples serve you well.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2020-11-24 14:58:59 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>